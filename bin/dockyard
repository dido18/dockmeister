#!/usr/bin/env ruby
$:.unshift(File.dirname('../lib'))

require 'dockyard'

DOCKER_COMPOSE_CMD = 'docker-compose --file ./docker-compose.yml'

command = ARGV.first

case command
when 'compose'
  composed = Dockyard::Composer.new('.').compose

  File.open('docker-compose.yml', 'w') { |f| f.write(composed.to_yaml) }
when 'build'
  Dockyard::ScriptRunner.new('.').pre_build!

  exec("#{DOCKER_COMPOSE_CMD} build")
when 'up'
  exec("#{DOCKER_COMPOSE_CMD} up")
else
  puts <<-eos
    USAGE
      dockyard [COMMAND]

    COMMANDS:

      - compose:  Prepares a composition of each configured services' "docker-compose.yml" file into a single `docker-compose.yml` file.

      - build:    Runs pre-build scripts for every service and builds the docker containers using "docker-compose build".
                  Pre-build scripts are all scripts starting with "init" in a services' "scripts" directory.

      - up:       Starts the containers using "docker-compose up"
    eos
end
